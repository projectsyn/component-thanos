apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations: {}
  labels:
    name: thanos-store-alerts
  name: thanos-store-alerts
  namespace: syn-thanos
spec:
  groups:
    - name: thanos-store
      rules:
        - alert: ThanosStoreGrpcErrorRate
          annotations:
            description: Thanos Store {{$labels.job}} is failing to handle {{$value
              | humanize}}% of requests.
            runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstoregrpcerrorrate
            summary: Thanos Store is failing to handle qrpcd requests.
          expr: "(\n  sum by (job) (rate(grpc_server_handled_total{grpc_code=~\"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded\"\
            , job=~\".*thanos-store.*\"}[5m]))\n/\n  sum by (job) (rate(grpc_server_started_total{job=~\"\
            .*thanos-store.*\"}[5m]))\n* 100 > 5\n)\n"
          for: 5m
          labels:
            severity: warning
            syn: 'true'
            syn_component: thanos
        - alert: ThanosStoreSeriesGateLatencyHigh
          annotations:
            description: Thanos Store {{$labels.job}} has a 99th percentile latency
              of {{$value}} seconds for store series gate requests.
            runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstoreseriesgatelatencyhigh
            summary: Thanos Store has high latency for store series gate requests.
          expr: "(\n  histogram_quantile(0.99, sum by (job, le) (rate(thanos_bucket_store_series_gate_duration_seconds_bucket{job=~\"\
            .*thanos-store.*\"}[5m]))) > 2\nand\n  sum by (job) (rate(thanos_bucket_store_series_gate_duration_seconds_count{job=~\"\
            .*thanos-store.*\"}[5m])) > 0\n)\n"
          for: 10m
          labels:
            severity: warning
            syn: 'true'
            syn_component: thanos
        - alert: ThanosStoreBucketHighOperationFailures
          annotations:
            description: Thanos Store {{$labels.job}} Bucket is failing to execute
              {{$value | humanize}}% of operations.
            runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstorebuckethighoperationfailures
            summary: Thanos Store Bucket is failing to execute operations.
          expr: "(\n  sum by (job) (rate(thanos_objstore_bucket_operation_failures_total{job=~\"\
            .*thanos-store.*\"}[5m]))\n/\n  sum by (job) (rate(thanos_objstore_bucket_operations_total{job=~\"\
            .*thanos-store.*\"}[5m]))\n* 100 > 5\n)\n"
          for: 15m
          labels:
            severity: warning
            syn: 'true'
            syn_component: thanos
        - alert: ThanosStoreObjstoreOperationLatencyHigh
          annotations:
            description: Thanos Store {{$labels.job}} Bucket has a 99th percentile
              latency of {{$value}} seconds for the bucket operations.
            runbook_url: https://github.com/thanos-io/thanos/tree/main/mixin/runbook.md#alert-name-thanosstoreobjstoreoperationlatencyhigh
            summary: Thanos Store is having high latency for bucket operations.
          expr: "(\n  histogram_quantile(0.99, sum by (job, le) (rate(thanos_objstore_bucket_operation_duration_seconds_bucket{job=~\"\
            .*thanos-store.*\"}[5m]))) > 2\nand\n  sum by (job) (rate(thanos_objstore_bucket_operation_duration_seconds_count{job=~\"\
            .*thanos-store.*\"}[5m])) > 0\n)\n"
          for: 10m
          labels:
            severity: warning
            syn: 'true'
            syn_component: thanos
